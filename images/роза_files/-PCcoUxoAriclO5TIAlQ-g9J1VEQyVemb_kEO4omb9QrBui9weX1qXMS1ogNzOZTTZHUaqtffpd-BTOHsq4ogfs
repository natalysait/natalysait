BEM.DOM.decl({block:"pane2",modName:"related-scroll-autoload",modVal:!0},{scrollInfo:function(){this.__base.apply(this,arguments),this._onScrollInfoThrottled()},_onScrollInfoThrottled:function(){this._throttledOnScrollInfo||(this._throttledOnScrollInfo=$.throttle(this.tryLoadMoreRelated,100,this)),this._throttledOnScrollInfo()},tryLoadMoreRelated:function(){this._shouldLoadMoreRelated()&&this._loadMoreRelated()},_shouldLoadMoreRelated:function(){var e=this.elem("column","type","info").scrollTop();return this.elem("column","type","info").height()+e>=this.elem("info-wrapper").outerHeight()-this.__self.BOTTOM_OFFSET},_loadMoreRelated:function(){var e=this.blockInside("related2");e&&e.tryLoadMore()}},{BOTTOM_OFFSET:300}),BEM.DOM.decl({block:"pane2-controller",modName:"related-scroll-autoload",modVal:!0},{_updateInfo:function(){var e=this.__base.apply(this,arguments),t=this._getPane();return e.then(function(){t.tryLoadMoreRelated()}),e}}),BEM.DOM.decl({block:"related2",modName:"load-more",modValue:!0},{load:function(){return this._expectedRimId="",this._currentIndex=0,this._successLoadingCount=0,this._imagesToRender=[],this._hidePreloader(),this.dropBlockInsideCache(),this.__base.apply(this,arguments)},tryLoadMore:function(){this._canLoadMore()&&this._loadRimByIndex(this._currentIndex)},_canLoadMore:function(){var e=this.params.config.maxLoadingCount;return(!e||this._successLoadingCount<e)&&this.hasMod("visible",!0)&&!this.hasMod("spinner-visible")},_loadRimByIndex:function(e){var t=this._rimSimilar[e];if(t&&t.id){var i=this._getLoadedRim(t.id);this._checkData(i,t.id)}else this._renderImages()},_checkData:function(e,t){return e?e.error||!e.data?this._loadRimByIndex(++this._currentIndex):(this._addImagesToRender(e.data),this._isEnoughToRender()?(this._renderImages(),void this._preloadNextImages(this.params.config.preloadingCount,this._currentIndex+1)):this._loadRimByIndex(++this._currentIndex)):this._startLoadingRimById(t)},_startLoadingRimById:function(e){this._expectedRimId=e,this._showPreloader(),this._loadRimData({id:e})},_addImagesToRender:function(e){e.forEach(function(e){this._renderedImages[e.id]||(this._renderedImages[e.id]=!0,this._imagesToRender.push(e))},this)},_isEnoughToRender:function(){var e=this.params.config.minRenderCount;return!!this._imagesToRender.length&&(!e||this._imagesToRender.length>=e)},_renderImages:function(){if(this._imagesToRender&&this._imagesToRender.length){var e=this._getRimContentItemsBEMJSON(this._imagesToRender);this._successLoadingCount++,this._rimSimilar=[].concat(this._rimSimilar,this._imagesToRender),this._sendCounter(this._imagesToRender),this._imagesToRender=[],this.blockInside("tiled-images").addItems(e),this._hidePreloader()}},_sendCounter:function(e){var t=e.map(function(e){var t=this._getRimLoader().getImageUrl(e);return this._getRimLoader().prepareImageIdUrlPair(e.id,t)},this);this.trigger("rim-loaded-more",t)},_preloadNextImages:function(e,t){if(e){var i=this._rimSimilar.slice(t,t+e).filter(function(e){return!this._getLoadedRim(e.id)},this);this._loadRimData(i)}},_loadRimData:function(e){this._getRimLoader().batchLoad([].concat(e))},_updateRim:function(e){var t=this.__base.apply(this,arguments);return this._renderedImages={},this._renderedImages[e.id]=!0,e&&e.data&&e.data.forEach(function(e){this._renderedImages[e.id]=!0},this),this._preloadNextImages(this.params.config.preloadingCount,this._currentIndex),t},_onRelatedFitted:function(){this._successLoadingCount||(this.__base.apply(this,arguments),this.show())},_showPreloader:function(){this.setMod("spinner-visible",!0),this.blockInside("spin2").setMod("progress","yes")},_hidePreloader:function(){this.delMod("spinner-visible"),this.blockInside("spin2").delMod("progress")},_getRimContentBEMJSON:function(){var e=this.__base.apply(this,arguments);return e.mods.add=!0,e},_onRimLoadComplete:function(e,t){this.__base.apply(this,arguments),this._expectedRimId===t.id&&(this._expectedRimId="",this._checkData(t,t.id))}}),BEM.DOM.decl({block:"tiled-images",modName:"add",modVal:!0},{addItems:function(e){this.dropElemCache("thumb item"),BEM.DOM.append(this.elem("items"),BEMHTML.apply(e)),this.fitImages()}});